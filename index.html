<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>KK SEWA</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #1e1e1e; color: #ddd; }
    h2 { text-align: center; margin: 10px 0 5px; color: #fff; }
    h4 { text-align: center; margin: 0 0 15px; font-weight: normal; color: #bbb; }

    .sticky-header { position: sticky; top: 0; z-index: 100; background: #252525; padding: 10px; border-bottom: 2px solid #444; }
    .summary { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 10px; }
    .card { flex: 1; min-width: 200px; background: #2e2e2e; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); color: #eee; }
    .card h3 { margin: 0 0 5px; font-size: 16px; color: #ffcc00; }
    .card p { margin: 0; font-size: 18px; font-weight: bold; color: #fff; }

    .filter-bar { text-align: center; margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
    input[type=text], select { padding: 8px; border: 1px solid #666; border-radius: 5px; background: #2a2a2a; color: #eee; }
    button { padding: 8px 14px; border: none; border-radius: 5px; background: #444; color: #fff; cursor: pointer; }
    button:hover { background: #555; }

    .table-container { width: 100%; overflow-x: auto; }
    table { border-collapse: collapse; width: 100%; background: #2a2a2a; color: #ddd; }
    th, td { border: 1px solid #444; padding: 6px; text-align: center; }
    th { background: #333; color: #ffcc00; position: sticky; top: 0; }
    tr:nth-child(even) { background: #242424; }
    tr:hover { background: #3a3a3a; }
    tfoot td { font-weight: bold; background: #333; color: #ffcc00; position: sticky; bottom: 0; }
  </style>
</head>
<body>
  <h2>Kertas Kerja Penerimaan</h2>
  <h4 id="subTitle">Periode Juli s.d. Oktober 2025</h4>

  <div class="sticky-header">
    <div class="summary">
      <div class="card"><h3>Total Tahun 2024</h3><p id="summary2024">0</p></div>
      <div class="card"><h3>Total Tahun 2025</h3><p id="summary2025">0</p></div>
      <div class="card"><h3>Total Semua</h3><p id="summaryAll">0</p></div>
      <div class="card"><h3 id="monthTitle">Total Semua (Bulan)</h3><p id="summaryAllMonth">0</p></div>
    </div>
    <div class="filter-bar">
      <input type="text" id="searchInput" placeholder="Cari data..." oninput="loadData()">
      <select id="monthDropdown" onchange="loadData()"><option value="">-- Pilih Bulan --</option></select>
      <select id="dateDropdown" onchange="loadData()"><option value="">-- Pilih Tanggal Setoran --</option></select>
      <button onclick="resetFilter()">Reset</button>
      <button onclick="loadData(true)">ðŸ”„ Refresh Data</button>
    </div>
  </div>

  <div class="table-container">
    <table id="dataTable">
      <thead>
        <tr>
          <th>No</th>
          <th>Tanggal Setoran</th>
          <th>No. Referensi IBB</th>
          <th>No. STS</th>
          <th>No. Bukti Setoran</th>
          <th>Nama Penghuni</th>
          <th>Rusunawa</th>
          <th>No. Unit</th>
          <th>Tarif Sewa</th>
          <th>Periode Sewa 2024</th>
          <th>Jlh Bulan 2024</th>
          <th>Pokok Sewa 2024</th>
          <th>Denda 2024</th>
          <th>Jumlah Pembayaran 2024</th>
          <th>Periode Sewa 2025</th>
          <th>Jlh Bulan 2025</th>
          <th>Pokok Sewa 2025</th>
          <th>Denda 2025</th>
          <th>Jumlah Pembayaran 2025</th>
          <th>Total Pembayaran</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td colspan="11">TOTAL</td>
          <td id="totalPokok2024">0</td>
          <td id="totalDenda2024">0</td>
          <td id="totalPembayaran2024">0</td>
          <td></td>
          <td></td>
          <td id="totalPokok2025">0</td>
          <td id="totalDenda2025">0</td>
          <td id="totalPembayaran2025">0</td>
          <td id="totalSemua">0</td>
        </tr>
      </tfoot>
    </table>
  </div>

<script>
async function loadData(forceRefresh = false) {
  try {
    const response = await fetch('/api/get_data' + (forceRefresh ? '?t=' + new Date().getTime() : ''));
    const data = await response.json();
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';

    const search = document.getElementById('searchInput').value.toLowerCase();
    const monthFilter = document.getElementById('monthDropdown').value;
    const dateFilter = document.getElementById('dateDropdown').value;

    let totalPokok2024 = 0, totalDenda2024 = 0, totalPembayaran2024 = 0;
    let totalPokok2025 = 0, totalDenda2025 = 0, totalPembayaran2025 = 0;
    let totalSemua = 0;

    // ðŸ”¹ Ambil daftar bulan & tanggal dari data
    const uniqueMonths = new Set();
    const uniqueDates = new Set();

    data.forEach(row => {
      if (row.tanggal_setoran) {
        const [day, month, year] = row.tanggal_setoran.split('/');
        const bulanTeks = getNamaBulan(parseInt(month));
        uniqueMonths.add(bulanTeks);
        uniqueDates.add(row.tanggal_setoran);
      }
    });

    // ðŸ”¹ Isi dropdown bulan (sekali saja)
    if (forceRefresh || document.getElementById('monthDropdown').options.length <= 1) {
      fillDropdown('monthDropdown', Array.from(uniqueMonths).sort((a, b) => bulanUrut(a) - bulanUrut(b)));
    }

    // ðŸ”¹ Isi dropdown tanggal sesuai bulan yang dipilih
    const dateDropdown = document.getElementById('dateDropdown');
    dateDropdown.innerHTML = '<option value="">-- Pilih Tanggal Setoran --</option>';

    const filteredDates = Array.from(uniqueDates).filter(tgl => {
      if (!monthFilter) return true;
      const [d, m] = tgl.split('/');
      const bulanTeks = getNamaBulan(parseInt(m));
      return bulanTeks === monthFilter;
    });

    filteredDates.sort((a, b) => urutTanggal(a, b)).forEach(tgl => {
      const opt = document.createElement('option');
      opt.value = tgl;
      opt.textContent = tgl;
      dateDropdown.appendChild(opt);
    });

    // ðŸ”¹ Filter data tabel
    const filtered = data.filter(row => {
      const nama = (row.nama_penghuni || '').toLowerCase();
      const ref = (row.no_referensi_ibb || '').toLowerCase();
      const unit = (row.no_unit || '').toLowerCase();
      const tanggal = row.tanggal_setoran || '';

      let cocok = nama.includes(search) || ref.includes(search) || unit.includes(search);

      if (monthFilter) {
        const [d, m] = tanggal.split('/');
        const bulanTeks = getNamaBulan(parseInt(m));
        if (bulanTeks !== monthFilter) cocok = false;
      }

      if (dateFilter && tanggal !== dateFilter) cocok = false;

      return cocok;
    });

    // ðŸ”¹ Tampilkan data ke tabel
    filtered.forEach((row, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${row.tanggal_setoran}</td>
        <td>${row.no_referensi_ibb}</td>
        <td>${row.no_sts}</td>
        <td>${row.no_bukti_setoran || ''}</td>
        <td>${row.nama_penghuni}</td>
        <td>${row.rusunawa || ''}</td>
        <td>${row.no_unit}</td>
        <td>${formatRupiah(row.tarif_sewa || 0)}</td>
        <td>${row.periode_2024}</td>
        <td>${row.jlh_bulan_2024 || ''}</td>
        <td>${formatRupiah(row.pokok_sewa_2024 || 0)}</td>
        <td>${formatRupiah(row.denda_2024 || 0)}</td>
        <td>${formatRupiah(row.jml_pembayaran_2024 || 0)}</td>
        <td>${row.periode_2025}</td>
        <td>${row.jlh_bulan_2025 || ''}</td>
        <td>${formatRupiah(row.pokok_sewa_2025 || 0)}</td>
        <td>${formatRupiah(row.denda_2025 || 0)}</td>
        <td>${formatRupiah(row.jml_pembayaran_2025 || 0)}</td>
        <td>${formatRupiah(row.jumlah_diterima || 0)}</td>
      `;
      tbody.appendChild(tr);

      totalPokok2024 += parseFloat(row.pokok_sewa_2024 || 0);
      totalDenda2024 += parseFloat(row.denda_2024 || 0);
      totalPembayaran2024 += parseFloat(row.jml_pembayaran_2024 || 0);
      totalPokok2025 += parseFloat(row.pokok_sewa_2025 || 0);
      totalDenda2025 += parseFloat(row.denda_2025 || 0);
      totalPembayaran2025 += parseFloat(row.jml_pembayaran_2025 || 0);
      totalSemua += parseFloat(row.jumlah_diterima || 0);
    });

    // ðŸ”¹ Update total dan summary
    document.getElementById('totalPokok2024').textContent = formatRupiah(totalPokok2024);
    document.getElementById('totalDenda2024').textContent = formatRupiah(totalDenda2024);
    document.getElementById('totalPembayaran2024').textContent = formatRupiah(totalPembayaran2024);
    document.getElementById('totalPokok2025').textContent = formatRupiah(totalPokok2025);
    document.getElementById('totalDenda2025').textContent = formatRupiah(totalDenda2025);
    document.getElementById('totalPembayaran2025').textContent = formatRupiah(totalPembayaran2025);
    document.getElementById('totalSemua').textContent = formatRupiah(totalSemua);
    document.getElementById('summary2024').textContent = formatRupiah(totalPembayaran2024);
    document.getElementById('summary2025').textContent = formatRupiah(totalPembayaran2025);
    document.getElementById('summaryAll').textContent  = formatRupiah(totalSemua);
    document.getElementById('summaryAllMonth').textContent = formatRupiah(totalSemua);
  } catch (e) {
    console.error('Gagal memuat data:', e);
  }
}

// ðŸ”¸ Fungsi bantu yang tetap sama
function fillDropdown(id, arr) {
  const dropdown = document.getElementById(id);
  dropdown.innerHTML = '<option value="">-- Pilih --</option>';
  arr.forEach(item => {
    const opt = document.createElement('option');
    opt.value = item;
    opt.textContent = item;
    dropdown.appendChild(opt);
  });
}

function urutTanggal(a, b) {
  const [da, ma, ya] = a.split('/').map(Number);
  const [db, mb, yb] = b.split('/').map(Number);
  return new Date(ya, ma - 1, da) - new Date(yb, mb - 1, db);
}

function bulanUrut(bulan) {
  const daftar = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  return daftar.indexOf(bulan) + 1;
}

function getNamaBulan(bulan) {
  const nama = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  return nama[bulan - 1] || '';
}

function formatRupiah(num) {
  let n = parseFloat(num);
  if (isNaN(n)) n = 0;
  return n.toLocaleString('id-ID');
}


loadData();
</script>
</body>
</html>
